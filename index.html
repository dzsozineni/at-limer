<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AT-Limer</title>

<style>
body{
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, sans-serif;
    background:#000;
    color:#fff;
}
.container{
    max-width:600px;
    margin:0 auto;
    padding:16px;
}
.title{
    font-size:28px;
    color:#7CFC00;
    font-weight:bold;
}
.status{
    font-size:14px;
    color:#888;
    margin-bottom:15px;
}
.btn{
    width:100%;
    padding:14px;
    margin-bottom:12px;
    border:none;
    border-radius:8px;
    font-size:16px;
    font-weight:500;
    background:#007AFF;
    color:#fff;
}
.btn:active{opacity:.7}
.section-title{
    margin:20px 0 10px 0;
    font-size:18px;
    color:#7CFC00;
}
.dashboard{display:none}
.dashboard.visible{display:block}
.overlay{
    position:fixed;
    inset:0;
    background:#000;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
}
.spinner{
    width:50px;
    height:50px;
    border:4px solid #333;
    border-top:4px solid #7CFC00;
    border-radius:50%;
    animation:spin 1s linear infinite;
}
@keyframes spin{
    0%{transform:rotate(0)}
    100%{transform:rotate(360deg)}
}
</style>
</head>

<body>

<div class="container">
    <div class="title">AT-Limer</div>
    <div class="status" id="status">Disconnected</div>

    <div class="dashboard" id="dashboard">
        <div style="display:flex;gap:20px;margin-bottom:20px;">
            <div style="flex:1;text-align:center;background:#111;padding:20px;border-radius:12px;">
                <div id="speedValue" style="font-size:42px;color:#7CFC00;">0</div>
                <div style="font-size:14px;color:#888;">km/h</div>
            </div>
            <div style="flex:1;text-align:center;background:#111;padding:20px;border-radius:12px;">
                <div id="batteryValue" style="font-size:42px;color:#7CFC00;">0%</div>
                <div style="font-size:14px;color:#888;">Battery</div>
            </div>
        </div>

        <button class="btn" onclick="toggleLock()">ðŸ”’ Lock / Unlock</button>
        <button class="btn" onclick="toggleLight()">ðŸ’¡ Light</button>

        <div class="section-title">Speed Modes</div>
        <button class="btn" onclick="setSpeed('eco')">ECO</button>
        <button class="btn" onclick="setSpeed('normal')">NORMAL</button>
        <button class="btn" onclick="setSpeed('sport')">SPORT</button>
        <button class="btn" onclick="setSpeed('unlock')">âš  SPEED UNLOCK</button>

        <button class="btn" style="background:#ff3b30" onclick="disconnect()">DISCONNECT</button>
    </div>
</div>

<!-- SCAN overlay -->
<div class="overlay" id="overlay">
    <button class="btn" onclick="startScan()">ðŸ”µ SCAN & CONNECT</button>
</div>

<script>
let device=null;
let characteristic=null;
let heartbeatTimer=null;
let locked=true;
let lightOn=false;

const SERVICE_UUID=0xFFE0;
const CHAR_UUID=0xFFE1;

function setStatus(msg){
    document.getElementById("status").textContent=msg;
}

function hexToBytes(hex){
    const bytes=[];
    for(let c=0;c<hex.length;c+=2)
        bytes.push(parseInt(hex.substr(c,2),16));
    return new Uint8Array(bytes);
}

async function sendHex(hex){
    if(!characteristic)return;
    await characteristic.writeValue(hexToBytes(hex));
}

async function startScan(){
    try{
        setStatus("Select device...");
        device=await navigator.bluetooth.requestDevice({
            filters:[
                {namePrefix:"AT-09"},
                {namePrefix:"BT"}
            ],
            optionalServices:[SERVICE_UUID]
        });

        setStatus("Connecting...");
        showSpinner();
        await connectDevice();

    }catch(e){
        setStatus("Scan cancelled");
    }
}

function showSpinner(){
    document.getElementById("overlay").innerHTML=
        '<div class="spinner"></div>';
}

async function connectDevice(){
    const server=await device.gatt.connect();
    const service=await server.getPrimaryService(SERVICE_UUID);
    characteristic=await service.getCharacteristic(CHAR_UUID);

    await characteristic.startNotifications();
    characteristic.addEventListener("characteristicvaluechanged",handleNotification);

    setStatus("Connected âœ”");
    document.getElementById("overlay").style.display="none";
    document.getElementById("dashboard").classList.add("visible");

    startHeartbeat();
}

function startHeartbeat(){
    stopHeartbeat();
    heartbeatTimer=setInterval(()=>{
        sendHex("4643110100084C494D4542494B45BE8A");
    },500);
}

function stopHeartbeat(){
    if(heartbeatTimer){
        clearInterval(heartbeatTimer);
        heartbeatTimer=null;
    }
}

function handleNotification(event){
    const bytes=new Uint8Array(event.target.value.buffer);
    if(bytes.length<20)return;

    // Speed byte index 8
    let speed=bytes[8];
    document.getElementById("speedValue").textContent=speed;

    // Battery byte index 19
    let battery=bytes[19];
    document.getElementById("batteryValue").textContent=battery+"%";

    document.getElementById("batteryValue").style.color=
        battery>20?"#7CFC00":"#ff3b30";
}

function disconnect(){
    stopHeartbeat();
    if(device && device.gatt.connected)
        device.gatt.disconnect();

    characteristic=null;
    device=null;

    setStatus("Disconnected");
    document.getElementById("dashboard").classList.remove("visible");
    document.getElementById("overlay").style.display="flex";
}

function toggleLock(){
    locked=!locked;
    if(locked){
        sendHex("464316610001F0E2AE");
    }else{
        sendHex("464316610001F1F28F");
    }
}

function toggleLight(){
    lightOn=!lightOn;
    if(lightOn){
        sendHex("464316120001F12B26");
    }else{
        sendHex("464316120001F03B07");
    }
}

function setSpeed(mode){
    if(mode==="eco")
        sendHex("464316110002EE0677");
    if(mode==="normal")
        sendHex("464316110002DC1066");
    if(mode==="sport")
        sendHex("464316110002023AD5");
    if(mode==="unlock")
        sendHex("46431611000200FF3A8B");
}

if(!navigator.bluetooth){
    document.body.innerHTML="<h2 style='color:red;padding:20px'>Web Bluetooth not supported. Use Bluefy on iOS.</h2>";
}
</script>

</body>
</html>
