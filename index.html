<!DOCTYPE html>

<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AT-Limer">
    <meta name="theme-color" content="#000000">

```
<title>AT-Limer</title>

<!-- App Icons -->
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: #0F1419;
        color: #fff;
        overflow-x: hidden;
        -webkit-user-select: none;
        user-select: none;
    }

    .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 16px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }

    .title {
        font-size: 30px;
        font-weight: bold;
        color: #7CFC00;
    }

    .subtitle {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
    }

    .close-btn {
        font-size: 26px;
        color: #ff3b30;
        cursor: pointer;
        padding: 8px;
        display: none;
        transition: transform 0.2s;
    }

    .close-btn:active {
        transform: scale(0.95);
    }

    .close-btn.visible {
        display: block;
    }

    .status {
        color: #888;
        margin-bottom: 16px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #7CFC00;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .btn {
        width: 100%;
        padding: 14px;
        margin-bottom: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        background: #007AFF;
        color: #fff;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn:active {
        transform: scale(0.98);
        opacity: 0.8;
    }

    .btn.danger {
        background: #ff3b30;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .dashboard {
        display: none;
    }

    .dashboard.visible {
        display: block;
    }

    .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #7CFC00;
        margin: 24px 0 12px 0;
    }

    .hidden {
        display: none;
    }

    /* Speed & Battery Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        border: 1px solid rgba(127, 252, 0, 0.1);
    }

    .stat-value {
        font-size: 48px;
        font-weight: bold;
        color: #7CFC00;
        line-height: 1;
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 14px;
        color: #888;
    }

    .battery-low {
        color: #ff3b30 !important;
    }

    /* Connecting Overlay */
    .connecting-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 20, 25, 0.98);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(10px);
    }

    .connecting-overlay.hidden {
        display: none;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(127, 252, 0, 0.2);
        border-top: 4px solid #7CFC00;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .connecting-text {
        font-size: 18px;
        color: #7CFC00;
        margin-bottom: 8px;
    }

    .connecting-hint {
        font-size: 14px;
        color: #888;
        text-align: center;
        max-width: 280px;
    }

    /* Install Prompt */
    .install-prompt {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #1A1F2E;
        padding: 16px;
        border-top: 1px solid #333;
        display: none;
        z-index: 999;
    }

    .install-prompt.visible {
        display: block;
    }

    .install-text {
        margin-bottom: 12px;
        font-size: 14px;
        color: #ccc;
    }

    /* Error State */
    .error-state {
        text-align: center;
        padding: 40px 20px;
    }

    .error-icon {
        font-size: 64px;
        margin-bottom: 16px;
    }

    .error-title {
        font-size: 20px;
        color: #ff3b30;
        margin-bottom: 8px;
    }

    .error-message {
        font-size: 14px;
        color: #888;
        line-height: 1.5;
        margin-bottom: 24px;
    }

    /* Responsive */
    @media (max-width: 480px) {
        .title {
            font-size: 24px;
        }
        .stat-value {
            font-size: 36px;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <!-- Connecting Overlay -->
        <div class="connecting-overlay" id="connectingOverlay">
            <div class="spinner"></div>
            <div class="connecting-text">Connecting...</div>
            <div class="connecting-hint">Select your device from the browser prompt</div>
        </div>

```
    <!-- Header -->
    <div class="header">
        <div>
            <div class="title">AT-Limer</div>
            <div class="subtitle">BLE Controller</div>
        </div>
        <div class="close-btn" id="closeBtn" onclick="disconnect()">‚úï</div>
    </div>

    <div class="status" id="statusContainer">
        <span class="status-dot" id="statusDot" style="display:none;"></span>
        <span id="status">Initializing...</span>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Speed & Battery Display -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="speedValue">0</div>
                <div class="stat-label">km/h</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value" id="batteryValue">0</div>
                <div class="stat-label">Battery %</div>
            </div>
        </div>
        
        <!-- Lock/Unlock -->
        <button class="btn" id="lockBtn" onclick="toggleLock()">
            <span id="lockIcon">üîí</span>
            <span id="lockText">LOCKED</span>
        </button>

        <!-- Light -->
        <button class="btn" id="lightBtn" onclick="toggleLight()">
            <span id="lightIcon">üí°</span>
            <span id="lightText">LIGHT OFF</span>
        </button>

        <!-- Speed Modes -->
        <div class="section-title">Speed Modes</div>
        <button class="btn" onclick="setSpeed('eco')">
            <span>üå±</span>
            <span>ECO</span>
        </button>
        <button class="btn" onclick="setSpeed('normal')">
            <span>‚ö°</span>
            <span>NORMAL</span>
        </button>
        <button class="btn" onclick="setSpeed('sport')">
            <span>üöÄ</span>
            <span>SPORT</span>
        </button>
        <button class="btn danger" onclick="setSpeed('unlock')">
            <span>‚ö†Ô∏è</span>
            <span>SPEED UNLOCK</span>
        </button>
    </div>
</div>

<!-- Install Prompt (iOS Safari) -->
<div class="install-prompt" id="installPrompt">
    <div class="install-text">
        üì± Install this app: Safari menu ‚Üí "Add to Home Screen"
    </div>
    <button class="btn" onclick="closeInstallPrompt()">Got it</button>
</div>

<script>
    // ========================================
    // STATE MANAGEMENT
    // ========================================
    const state = {
        device: null,
        server: null,
        service: null,
        characteristic: null,
        locked: true,
        lightOn: false,
        heartbeatTimer: null,
        reconnectAttempts: 0,
        maxReconnectAttempts: 3,
        telemetry: {
            speed: 0,
            battery: 0,
            voltage: 0,
            current: 0,
            temperature: 0
        }
    };

    const CONFIG = {
        SERVICE_UUID: 0xFFE0,
        CHAR_UUID: 0xFFE1,
        HEARTBEAT_INTERVAL: 500,
        DEVICE_FILTERS: [
            { namePrefix: 'AT-09' },
            { namePrefix: 'BT' }
        ]
    };

    // ========================================
    // UI HELPERS
    // ========================================
    function setStatus(msg, isConnected = false) {
        const statusEl = document.getElementById('status');
        const dotEl = document.getElementById('statusDot');
        
        statusEl.textContent = msg;
        dotEl.style.display = isConnected ? 'block' : 'none';
    }

    function showDashboard() {
        document.getElementById('connectingOverlay').classList.add('hidden');
        document.getElementById('dashboard').classList.add('visible');
        document.getElementById('closeBtn').classList.add('visible');
    }

    function hideDashboard() {
        document.getElementById('dashboard').classList.remove('visible');
        document.getElementById('closeBtn').classList.remove('visible');
    }

    function showError(title, message) {
        const overlay = document.getElementById('connectingOverlay');
        overlay.innerHTML = `
            <div class="error-state">
                <div class="error-icon">‚ö†Ô∏è</div>
                <div class="error-title">${title}</div>
                <div class="error-message">${message}</div>
                <button class="btn" onclick="retryConnection()">
                    üîÑ Retry
                </button>
            </div>
        `;
        overlay.classList.remove('hidden');
    }

    // ========================================
    // HEX UTILITIES
    // ========================================
    function hexToBytes(hex) {
        const bytes = [];
        for (let i = 0; i < hex.length; i += 2) {
            bytes.push(parseInt(hex.substr(i, 2), 16));
        }
        return new Uint8Array(bytes);
    }

    function bytesToHex(bytes) {
        return Array.from(bytes)
            .map(b => b.toString(16).padStart(2, '0'))
            .join('').toUpperCase();
    }

    // ========================================
    // CRC VERIFICATION
    // ========================================
    function verifyCRC16(data) {
        if (data.length < 2) return false;
        
        const dataWithoutCRC = data.slice(0, -2);
        const receivedCRC = (data[data.length - 2] << 8) | data[data.length - 1];
        const calculatedCRC = calculateCRC16XMODEM(dataWithoutCRC);
        
        return receivedCRC === calculatedCRC;
    }

    function calculateCRC16XMODEM(data) {
        let crc = 0x0000;
        
        for (let byte of data) {
            crc ^= byte << 8;
            
            for (let i = 0; i < 8; i++) {
                if ((crc & 0x8000) !== 0) {
                    crc = (crc << 1) ^ 0x1021;
                } else {
                    crc = crc << 1;
                }
            }
        }
        
        return crc & 0xFFFF;
    }

    // ========================================
    // BLE COMMUNICATION
    // ========================================
    async function sendCommand(hex) {
        if (!state.characteristic) {
            console.warn('No characteristic available');
            return false;
        }

        try {
            const data = hexToBytes(hex);
            await state.characteristic.writeValue(data);
            console.log('‚úì Sent:', hex);
            return true;
        } catch (err) {
            console.error('‚úó Write error:', err);
            return false;
        }
    }

    function handleNotification(event) {
        const value = event.target.value;
        const bytes = new Uint8Array(value.buffer);
        
        console.log('‚Üê Received:', bytes.length, 'bytes:', bytesToHex(bytes));
        
        // Validate packet length
        if (bytes.length !== 42) {
            console.warn('Invalid packet length:', bytes.length);
            return;
        }
        
        // Verify CRC
        if (!verifyCRC16(bytes)) {
            console.warn('CRC check failed');
            return;
        }
        
        // Parse telemetry
        const speed = bytes[8];  // Byte 9 (index 8)
        const battery = bytes[19]; // Byte 20 (index 19)
        
        // Update state
        state.telemetry.speed = speed;
        state.telemetry.battery = battery;
        
        // Update UI
        updateTelemetryDisplay();
    }

    function updateTelemetryDisplay() {
        const { speed, battery } = state.telemetry;
        
        // Update speed
        document.getElementById('speedValue').textContent = speed;
        
        // Update battery with color
        const batteryEl = document.getElementById('batteryValue');
        batteryEl.textContent = battery;
        batteryEl.className = 'stat-value' + (battery <= 20 ? ' battery-low' : '');
        
        console.log(`üìä Speed: ${speed} km/h | Battery: ${battery}%`);
    }

    // ========================================
    // HEARTBEAT
    // ========================================
    function startHeartbeat() {
        stopHeartbeat();
        
        state.heartbeatTimer = setInterval(() => {
            sendCommand('4643110100084C494D4542494B45BE8A');
        }, CONFIG.HEARTBEAT_INTERVAL);
        
        console.log('üíì Heartbeat started (500ms)');
    }

    function stopHeartbeat() {
        if (state.heartbeatTimer) {
            clearInterval(state.heartbeatTimer);
            state.heartbeatTimer = null;
            console.log('üíî Heartbeat stopped');
        }
    }

    // ========================================
    // CONNECTION MANAGEMENT
    // ========================================
    async function connectToDevice() {
        try {
            setStatus('Requesting device...');
            
            // Request device
            state.device = await navigator.bluetooth.requestDevice({
                filters: CONFIG.DEVICE_FILTERS,
                optionalServices: [CONFIG.SERVICE_UUID]
            });

            console.log('üì± Device selected:', state.device.name);
            setStatus('Connecting to ' + state.device.name);

            // Connect GATT server
            state.server = await state.device.gatt.connect();
            console.log('üîó GATT connected');
            
            setStatus('Discovering services...');

            // Get service
            state.service = await state.server.getPrimaryService(CONFIG.SERVICE_UUID);
            console.log('üîç Service found');

            // Get characteristic
            state.characteristic = await state.service.getCharacteristic(CONFIG.CHAR_UUID);
            console.log('üìù Characteristic found');

            // Subscribe to notifications
            await state.characteristic.startNotifications();
            state.characteristic.addEventListener('characteristicvaluechanged', handleNotification);
            console.log('üì¨ Notifications enabled');

            // Setup disconnect handler
            state.device.addEventListener('gattserverdisconnected', handleDisconnect);

            // Success!
            setStatus('Connected ‚úî', true);
            showDashboard();
            startHeartbeat();
            
            // Reset reconnect counter
            state.reconnectAttempts = 0;

        } catch (err) {
            console.error('Connection error:', err);
            handleConnectionError(err);
        }
    }

    function handleConnectionError(err) {
        if (err.name === 'NotFoundError') {
            setStatus('No device selected');
            showError('No Device Selected', 'Please select a device to continue.');
        } else if (err.name === 'NotSupportedError') {
            showError(
                'Bluetooth Not Supported',
                'Please use:<br>‚Ä¢ Bluefy browser on iOS<br>‚Ä¢ Chrome or Edge on Android'
            );
        } else {
            setStatus('Connection failed');
            showError('Connection Failed', err.message || 'Unknown error occurred.');
        }
    }

    async function handleDisconnect() {
        console.log('üîå Device disconnected');
        
        stopHeartbeat();
        setStatus('Device disconnected');
        hideDashboard();
        
        // Auto-reconnect logic
        if (state.reconnectAttempts < state.maxReconnectAttempts) {
            state.reconnectAttempts++;
            setStatus(`Reconnecting (${state.reconnectAttempts}/${state.maxReconnectAttempts})...`);
            
            setTimeout(() => {
                if (state.device && state.device.gatt) {
                    state.device.gatt.connect()
                        .then(() => connectToDevice())
                        .catch(err => {
                            console.error('Reconnect failed:', err);
                        });
                }
            }, 2000);
        } else {
            showError('Connection Lost', 'Device disconnected. Please reconnect manually.');
        }
    }

    async function disconnect() {
        console.log('üëã Manual disconnect');
        
        stopHeartbeat();
        
        if (state.characteristic) {
            try {
                await state.characteristic.stopNotifications();
                state.characteristic.removeEventListener('characteristicvaluechanged', handleNotification);
            } catch (err) {
                console.error('Error stopping notifications:', err);
            }
        }
        
        if (state.server && state.server.connected) {
            state.server.disconnect();
        }
        
        // Reset state
        state.device = null;
        state.server = null;
        state.service = null;
        state.characteristic = null;
        state.reconnectAttempts = 0;
        
        setStatus('Disconnected');
        hideDashboard();
    }

    function retryConnection() {
        state.reconnectAttempts = 0;
        const overlay = document.getElementById('connectingOverlay');
        overlay.innerHTML = `
            <div class="spinner"></div>
            <div class="connecting-text">Connecting...</div>
            <div class="connecting-hint">Select your device from the browser prompt</div>
        `;
        connectToDevice();
    }

    // ========================================
    // CONTROL FUNCTIONS
    // ========================================
    function toggleLock() {
        state.locked = !state.locked;
        
        const icon = document.getElementById('lockIcon');
        const text = document.getElementById('lockText');
        
        if (state.locked) {
            icon.textContent = 'üîí';
            text.textContent = 'LOCKED';
            sendCommand('464316610001F0E2AE');
            sendCommand('464316120001F03B07');
        } else {
            icon.textContent = 'üîì';
            text.textContent = 'UNLOCKED';
            sendCommand('464316610001F1F28F');
            sendCommand('464316120001F12B26');
        }
    }

    function toggleLight() {
        state.lightOn = !state.lightOn;
        
        const icon = document.getElementById('lightIcon');
        const text = document.getElementById('lightText');
        
        if (state.lightOn) {
            icon.textContent = 'üí°';
            text.textContent = 'LIGHT ON';
            sendCommand('464316120001F12B26');
        } else {
            icon.textContent = 'üí°';
            text.textContent = 'LIGHT OFF';
            sendCommand('464316120001F03B07');
        }
    }

    function setSpeed(mode) {
        const commands = {
            'eco': '464316110002EE0677',
            'normal': '464316110002DC1066',
            'sport': '464316110002023AD5',
            'unlock': '46431611000200FF3A8B'
        };
        
        if (commands[mode]) {
            sendCommand(commands[mode]);
            console.log(`üèéÔ∏è Speed mode: ${mode.toUpperCase()}`);
        }
    }

    // ========================================
    // INSTALL PROMPT
    // ========================================
    function showInstallPrompt() {
        const isStandalone = window.navigator.standalone || 
                            window.matchMedia('(display-mode: standalone)').matches;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (!isStandalone && isIOS && !localStorage.getItem('installPromptClosed')) {
            document.getElementById('installPrompt').classList.add('visible');
        }
    }

    function closeInstallPrompt() {
        document.getElementById('installPrompt').classList.remove('visible');
        localStorage.setItem('installPromptClosed', 'true');
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    window.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ AT-Limer initialized');
        
        // Check Bluetooth support
        if (!navigator.bluetooth) {
            showError(
                'Web Bluetooth Not Supported',
                'Please use:<br>‚Ä¢ <strong>Bluefy</strong> browser on iOS<br>‚Ä¢ <strong>Chrome</strong> or <strong>Edge</strong> on Android'
            );
            return;
        }
        
        // Auto-start connection
        setTimeout(() => {
            connectToDevice();
        }, 500);
        
        // Show install prompt
        setTimeout(showInstallPrompt, 3000);
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(() => console.log('‚úì Service Worker registered'))
            .catch(err => console.error('‚úó SW registration failed:', err));
    }
</script>
```

</body>
</html>
