<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AT-Limer</title>

<style>
body{
    background:#0F1419;
    color:white;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI';
    margin:0;
    padding:20px;
}
.title{
    font-size:28px;
    color:#7CFC00;
    font-weight:bold;
}
.status{
    margin:10px 0;
    color:#aaa;
}
.card{
    background:#1A1F2E;
    padding:20px;
    border-radius:12px;
    text-align:center;
    margin-bottom:15px;
}
.value{
    font-size:42px;
    font-weight:bold;
    color:#7CFC00;
}
.btn{
    width:100%;
    padding:14px;
    margin-top:10px;
    border:none;
    border-radius:8px;
    font-size:16px;
    background:#007AFF;
    color:white;
}
.btn:active{opacity:0.7;}
.btn.red{background:#ff3b30;}

.overlay{
    position:fixed;
    top:0;left:0;right:0;bottom:0;
    background:#0F1419;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
}
.spinner{
    width:50px;
    height:50px;
    border:4px solid #333;
    border-top:4px solid #7CFC00;
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-bottom:20px;
}
@keyframes spin{
    from{transform:rotate(0deg);}
    to{transform:rotate(360deg);}
}
.hidden{display:none;}
</style>
</head>

<body>

<div id="overlay" class="overlay">
    <div class="spinner"></div>
    <div>Connecting...</div>
</div>

<div class="title">AT-Limer</div>
<div class="status" id="status">Initializing...</div>

<div id="dashboard" class="hidden">

<div class="card">
    <div id="speedValue" class="value">0.0</div>
    km/h
</div>

<div class="card">
    <div id="batteryValue" class="value">0</div>
    Battery %
</div>

<button class="btn" onclick="toggleLock()">ðŸ”’ Lock / Unlock</button>
<button class="btn" onclick="toggleLight()">ðŸ’¡ Light</button>

<button class="btn" onclick="setSpeed('eco')">ECO</button>
<button class="btn" onclick="setSpeed('normal')">NORMAL</button>
<button class="btn" onclick="setSpeed('sport')">SPORT</button>

<button class="btn red" onclick="disconnect()">Disconnect</button>

</div>

<script>

let device=null;
let characteristic=null;
let heartbeatTimer=null;
let locked=true;
let lightOn=false;

const SERVICE_UUID=0xFFE0;
const CHAR_UUID=0xFFE1;

function setStatus(t){
    document.getElementById("status").textContent=t;
}

function showDashboard(){
    document.getElementById("overlay").classList.add("hidden");
    document.getElementById("dashboard").classList.remove("hidden");
}

function showOverlay(){
    document.getElementById("overlay").classList.remove("hidden");
    document.getElementById("dashboard").classList.add("hidden");
}

function hexToBytes(hex){
    const bytes=[];
    for(let c=0;c<hex.length;c+=2){
        bytes.push(parseInt(hex.substr(c,2),16));
    }
    return new Uint8Array(bytes);
}

function calculateCRC16XMODEM(data){
    let crc=0x0000;
    for(let byte of data){
        crc^=byte<<8;
        for(let i=0;i<8;i++){
            if((crc&0x8000)!==0){
                crc=(crc<<1)^0x1021;
            }else{
                crc=crc<<1;
            }
        }
    }
    return crc&0xFFFF;
}

function verifyCRC(data){
    if(data.length<2)return false;
    const body=data.slice(0,-2);
    const received=(data[data.length-2]<<8)|data[data.length-1];
    return received===calculateCRC16XMODEM(body);
}

async function connect(){
    try{
        setStatus("Requesting device...");
        device=await navigator.bluetooth.requestDevice({
            acceptAllDevices:true,
            optionalServices:[SERVICE_UUID]
        });

        setStatus("Connecting...");
        const server=await device.gatt.connect();
        const service=await server.getPrimaryService(SERVICE_UUID);
        characteristic=await service.getCharacteristic(CHAR_UUID);

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged',handleNotify);

        device.addEventListener('gattserverdisconnected',()=>{
            stopHeartbeat();
            showOverlay();
            setStatus("Disconnected");
        });

        startHeartbeat();
        showDashboard();
        setStatus("Connected âœ”");

    }catch(e){
        setStatus("Connection failed");
        showOverlay();
        console.log(e);
    }
}

async function disconnect(){
    stopHeartbeat();
    if(device && device.gatt.connected){
        device.gatt.disconnect();
    }
    showOverlay();
    setStatus("Disconnected");
}

function startHeartbeat(){
    stopHeartbeat();
    heartbeatTimer=setInterval(()=>{
        sendHex('4643110100084C494D4542494B45BE8A');
    },500);
}

function stopHeartbeat(){
    if(heartbeatTimer){
        clearInterval(heartbeatTimer);
        heartbeatTimer=null;
    }
}

async function sendHex(hex){
    if(!characteristic)return;
    await characteristic.writeValue(hexToBytes(hex));
}

function handleNotify(event){
    const bytes=new Uint8Array(event.target.value.buffer);
    if(bytes.length!==42)return;
    if(!verifyCRC(bytes))return;

    const rawSpeed=bytes[8];
    const speed=(rawSpeed*0.2).toFixed(1);
    const battery=bytes[19];

    document.getElementById("speedValue").textContent=speed;
    document.getElementById("batteryValue").textContent=battery;
}

function toggleLock(){
    locked=!locked;
    sendHex(locked?'464316610001F0E2AE':'464316610001F1F28F');
}

function toggleLight(){
    lightOn=!lightOn;
    sendHex(lightOn?'464316120001F12B26':'464316120001F03B07');
}

function setSpeed(mode){
    const commands={
        eco:'464316110002EE0677',
        normal:'464316110002DC1066',
        sport:'464316110002023AD5'
    };
    if(commands[mode])sendHex(commands[mode]);
}

window.addEventListener("DOMContentLoaded",()=>{
    if(!navigator.bluetooth){
        setStatus("Web Bluetooth not supported");
        return;
    }
    setTimeout(connect,500); // âœ… AUTO CONNECT VISSZARAKVA
});

</script>
</body>
</html>
